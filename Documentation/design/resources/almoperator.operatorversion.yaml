apiVersion: app.coreos.com/v1alpha1
kind: OperatorVersion-v1
metadata:
  name: alm-operator
spec:
  version: 0.0.1
  maturity: pre-alpha
  requirements:
  - kind: CustomResourceDefinition
    apiVersion: v1beta1
    name: apptypes.app.coreos.com
    sha256: a916282c05b74d39076e223ebde312f6de2346f1fbb87c75bb315cad9cc6eab7
  - kind: ConfigMap
    apiVersion: v1
    name: cluster-features
    namespace: kube-system
    matchExpressions:
      - {key: features.apiextension, operator: In, values: [true]}
  - kind: ServiceAccount
    apiVersion: v1
    name: alm-service
    namespace: kube-system
    rules:
    # This is a list of permissions that are required for the operator compenent (using the above serviceAccount)
    # to do its job. A user with appropriate permissions will need to create it (automated in tectonic UI w/ impersonation)
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list", "watch"]
    - apiGroups: ["batch", "extensions"]
      resources: ["jobs"]
      verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
    - apiGroups: [""]
      resources: ["configmaps"]
      resourceNames: ["my-config"]
      verbs: ["get"]
  - kind: ServiceAccount
    apiVersion: v1
    name: alm-cluster-aware-service
    namespace: kube-system
    rules:
    - apiGroups: [""]
      resources: ["configmaps"]
      resourceNames: ["cluster-features"]
      verbs: ["get"]
  installStrategy:
    kind: deployment
    items:
      apiVersion: extensions/v1beta1
      kind: Deployment
      metadata:
        name: alm-operator
        namespace: alm-app
        labels:
          app: alm
      spec:
        replicas: 1
        template:
          metadata:
            labels:
              app: alm
          spec:
            containers:
              - name: alm
                image: quay.io/quay/alm:master
                imagePullPolicy: always
                ports:
                  - containerPort: 8080
                livenessProbe:
                  httpGet:
                    path: /healthz
                    port: 8080
                readinessProbe:
                  httpGet:
                    path: /healthz
                    port: 8080
            imagePullSecrets:
              - name: coreos-pull-secret
