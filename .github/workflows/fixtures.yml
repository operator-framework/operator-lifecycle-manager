name: fixtures
on:
  push:
    branches:
      - master
jobs:
  rebuild:
    if: ${{ needs.build.outputs.UPDATE_FIXTURES == 'true' && success() }}
    needs: e2e-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: images/
      - name: Load Docker images
        run: |
          for image in images/*.tar.gz; do
            docker load -i $image
          done
      - name: Push fixture images
        run: scripts/e2e_test_fixtures.sh --push --skip-build
