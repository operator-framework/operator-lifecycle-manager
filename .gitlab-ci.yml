# Generated from .gitlab-ci.jsonnet 
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN 
---
container-base-build:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  image: docker:git
  only:
  - schedules
  - tags
  script:
  - 'docker build --build-arg sshkey=$OPERATORCLENT_RSA_B64 --no-cache -f base.Dockerfile -t quay.io/coreos/alm-ci:base . '
  - docker push quay.io/coreos/alm-ci:base
  stage: docker_base
  tags:
  - kubernetes
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker-host.gitlab-runner.svc.cluster.local:2375
container-build:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  - mkdir -p $PWD/bin
  image: docker:git
  script:
  - 'docker build  --no-cache -f alm-ci.Dockerfile -t quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG} . '
  - docker push quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG}
  - 'docker build  --no-cache -f catalog-ci.Dockerfile -t quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG} . '
  - docker push quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG}
  - docker create quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG} | xargs -I{} docker cp {}:/bin/alm bin/alm
  - docker create quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG} | xargs -I{} docker cp {}:/bin/catalog bin/catalog
  - 'docker build  --no-cache -f alm-pre.Dockerfile -t quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG}-pre . '
  - docker push quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG}-pre
  - 'docker build  --no-cache -f catalog-pre.Dockerfile -t quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG}-pre . '
  - docker push quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG}-pre
  - 'docker build  --no-cache -f e2e-run.Dockerfile -t quay.io/coreos/alm-e2e:${CI_COMMIT_REF_SLUG}-${SHA8} . '
  - docker push quay.io/coreos/alm-e2e:${CI_COMMIT_REF_SLUG}-${SHA8}
  stage: docker_build
  tags:
  - kubernetes
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker-host.gitlab-runner.svc.cluster.local:2375
container-release:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  - mkdir -p $PWD/bin
  image: docker:git
  only:
  - master
  - tags
  script:
  - docker pull quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG}-pre
  - docker tag quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG}-pre quay.io/coreos/alm:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker push quay.io/coreos/alm:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker pull quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG}-pre
  - docker tag quay.io/coreos/catalog-ci:${CI_COMMIT_REF_SLUG}-pre quay.io/coreos/catalog:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker push quay.io/coreos/catalog:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker pull quay.io/coreos/alm-e2e:${CI_COMMIT_REF_SLUG}-${SHA8}
  - docker tag quay.io/coreos/alm-e2e:${CI_COMMIT_REF_SLUG}-${SHA8} quay.io/coreos/alm-e2e:latest
  - docker push quay.io/coreos/alm-e2e:latest
  stage: docker_release
  tags:
  - kubernetes
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker-host.gitlab-runner.svc.cluster.local:2375
deploy-preview:
  before_script:
  - 'echo "version: 1.0.0-${CI_COMMIT_REF_SLUG}-pre" >> deploy/chart/kube-1.7/Chart.yaml'
  - 'echo "{\"alm.image.repository\": \"quay.io/coreos/alm-ci\", \"alm.image.tag\": \"${CI_COMMIT_REF_SLUG}-pre\", \"catalog.image.repository\": \"quay.io/coreos/catalog-ci\", \"catalog.image.tag\": \"${CI_COMMIT_REF_SLUG}-pre\",
    \"catalog_namespace\": \"tectonic-system\", \"namespace\": \"ci-alm-${CI_COMMIT_REF_SLUG}\"}" > params.json'
  - cat params.json
  environment:
    name: review/ci-alm-${CI_COMMIT_REF_SLUG}
    on_stop: stop-preview
    url: https://alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
  except:
  - master
  - tags
  image: quay.io/coreos/alm-ci-build:latest
  only:
  - branches
  script:
  - kubectl create ns ci-alm-${CI_COMMIT_REF_SLUG} || true
  - kubectl create secret docker-registry coreos-pull-secret --docker-server quay.io --docker-username $DOCKER_USER --docker-password $DOCKER_PASS --docker-email ignored@example.com --namespace=ci-alm-${CI_COMMIT_REF_SLUG}
    || true
  - helm upgrade ci-alm-${CI_COMMIT_REF_SLUG} --install deploy/chart/kube-1.7 --namespace=ci-alm-${CI_COMMIT_REF_SLUG} --set alm.image.repository=quay.io/coreos/alm-ci --set alm.image.tag=${CI_COMMIT_REF_SLUG}-pre
    --set catalog.image.repository=quay.io/coreos/catalog-ci --set catalog.image.tag=${CI_COMMIT_REF_SLUG}-pre --set catalog_namespace=tectonic-system --set namespace=ci-alm-${CI_COMMIT_REF_SLUG}
  stage: deploy_preview
  tags:
  - kubernetes
  variables:
    ALM_DOMAIN: alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
    K8S_NAMESPACE: ci-alm-${CI_COMMIT_REF_SLUG}
  when: manual
deploy-staging:
  before_script:
  - 'echo "version: 1.0.0-${CI_COMMIT_REF_SLUG}-pre" >> deploy/chart/kube-1.7/Chart.yaml'
  - 'echo "{\"alm.image.repository\": \"quay.io/coreos/alm\", \"alm.image.tag\": \"${CI_COMMIT_REF_SLUG}-${SHA8}\", \"catalog.image.repository\": \"quay.io/coreos/catalog\", \"catalog.image.tag\": \"${CI_COMMIT_REF_SLUG}-${SHA8}\",
    \"catalog_namespace\": \"tectonic-system\", \"namespace\": \"ci-alm-staging\"}" > params.json'
  - cat params.json
  environment:
    name: staging
    url: https://alm-staging.k8s.devtable.com
  image: quay.io/coreos/alm-ci-build:latest
  only:
  - master
  script:
  - kubectl create ns ci-alm-staging || true
  - kubectl create secret docker-registry coreos-pull-secret --docker-server quay.io --docker-username $DOCKER_USER --docker-password $DOCKER_PASS --docker-email ignored@example.com --namespace=ci-alm-staging
    || true
  - helm upgrade ci-alm-staging --install deploy/chart/kube-1.7 --namespace=ci-alm-staging --set alm.image.repository=quay.io/coreos/alm --set alm.image.tag=${CI_COMMIT_REF_SLUG}-${SHA8} --set catalog.image.repository=quay.io/coreos/catalog
    --set catalog.image.tag=${CI_COMMIT_REF_SLUG}-${SHA8} --set catalog_namespace=tectonic-system --set namespace=ci-alm-staging --force
  stage: deploy_staging
  tags:
  - kubernetes
  variables:
    ALM_DOMAIN: alm-staging.k8s.devtable.com
    K8S_NAMESPACE: ci-alm-staging
e2e-setup:
  before_script:
  - 'echo "version: 1.0.0-${CI_COMMIT_REF_SLUG}-pre" >> deploy/chart/kube-1.7/Chart.yaml'
  - 'echo "{\"alm.image.repository\": \"quay.io/coreos/alm-ci\", \"alm.image.tag\": \"${CI_COMMIT_REF_SLUG}-pre\", \"catalog.image.repository\": \"quay.io/coreos/catalog-ci\", \"catalog.image.tag\": \"${CI_COMMIT_REF_SLUG}-pre\",
    \"catalog_namespace\": \"e2e-${CI_COMMIT_REF_SLUG}\", \"namespace\": \"e2e-${CI_COMMIT_REF_SLUG}\"}" > params.json'
  - cat params.json
  environment:
    name: review/e2e-${CI_COMMIT_REF_SLUG}
    url: https://alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
  image: quay.io/coreos/alm-ci-build:latest
  script:
  - kubectl create ns e2e-${CI_COMMIT_REF_SLUG} || true
  - kubectl create secret docker-registry coreos-pull-secret --docker-server quay.io --docker-username $DOCKER_USER --docker-password $DOCKER_PASS --docker-email ignored@example.com --namespace=e2e-${CI_COMMIT_REF_SLUG}
    || true
  - helm upgrade e2e-${CI_COMMIT_REF_SLUG} --install deploy/chart/kube-1.7 --namespace=e2e-${CI_COMMIT_REF_SLUG} --set alm.image.repository=quay.io/coreos/alm-ci --set alm.image.tag=${CI_COMMIT_REF_SLUG}-pre
    --set catalog.image.repository=quay.io/coreos/catalog-ci --set catalog.image.tag=${CI_COMMIT_REF_SLUG}-pre --set catalog_namespace=e2e-${CI_COMMIT_REF_SLUG} --set namespace=e2e-${CI_COMMIT_REF_SLUG}
  stage: test_setup
  tags:
  - kubernetes
  variables:
    ALM_DOMAIN: alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
    K8S_NAMESPACE: e2e-${CI_COMMIT_REF_SLUG}
e2e-teardown:
  before_script: []
  environment:
    action: stop
    name: review/e2e-${CI_COMMIT_REF_SLUG}
    url: https://alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
  image: quay.io/coreos/alm-ci-build:latest
  script:
  - helm del --purge e2e-${CI_COMMIT_REF_SLUG}
  - kubectl delete ns e2e-${CI_COMMIT_REF_SLUG}
  - kubectl get pods -o wide -n e2e-${CI_COMMIT_REF_SLUG}
  stage: test_teardown
  tags:
  - kubernetes
  variables:
    ALM_DOMAIN: alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
    GIT_STRATEGY: none
    K8S_NAMESPACE: e2e-${CI_COMMIT_REF_SLUG}
  when: always
e2e_tests:
  image:
    name: quay.io/coreos/alm-e2e:${CI_COMMIT_REF_SLUG}-${SHA8}
  script:
  - ./e2e/e2e.sh
  stage: tests
  tags:
  - kubernetes
  variables:
    K8S_NAMESPACE: e2e-${CI_COMMIT_REF_SLUG}
    NAMESPACE: e2e-${CI_COMMIT_REF_SLUG}
stages:
- docker_base
- docker_build
- deploy_preview
- test_setup
- tests
- test_teardown
- integration
- docker_release
- deploy_staging
- teardown
stop-preview:
  before_script: []
  environment:
    action: stop
    name: review/ci-alm-${CI_COMMIT_REF_SLUG}
    url: https://alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
  except:
  - master
  - tags
  image: quay.io/coreos/alm-ci-build:latest
  only:
  - branches
  script:
  - helm del --purge ci-alm-${CI_COMMIT_REF_SLUG}
  - kubectl delete ns ci-alm-${CI_COMMIT_REF_SLUG}
  - kubectl get pods -o wide -n ci-alm-${CI_COMMIT_REF_SLUG}
  stage: deploy_preview
  tags:
  - kubernetes
  variables:
    ALM_DOMAIN: alm-${CI_COMMIT_REF_SLUG}.k8s.devtable.com
    GIT_STRATEGY: none
    K8S_NAMESPACE: ci-alm-${CI_COMMIT_REF_SLUG}
  when: manual
unit-tests:
  before_script:
  - mkdir -p $GOPATH/src/github.com/coreos-inc/alm
  - cp -a $CI_PROJECT_DIR/* $GOPATH/src/github.com/coreos-inc/alm
  - cd $GOPATH/src/github.com/coreos-inc/alm
  coverage: /\d\d\.\d.$/
  image: quay.io/coreos/alm-ci:${CI_COMMIT_REF_SLUG}
  script:
  - make codegen && git diff --exit-code
  - make vendor
  - make test-cover
  stage: tests
  tags:
  - kubernetes
variables:
  FAILFASTCI_NAMESPACE: quay
